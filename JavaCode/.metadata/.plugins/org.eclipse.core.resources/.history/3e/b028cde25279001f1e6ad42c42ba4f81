package cs523.bitcoinprice.producer;

import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.WebSocket;
import okhttp3.WebSocketListener;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.serialization.StringSerializer;
import org.json.JSONObject;

import java.util.Properties;

public class BitcoinPriceProducer {

    // CoinAPI Key
    private static final String API_KEY = "364167C8-AB6B-40ED-8E1D-9313DFAD82FE";
    private static final String KAFKA_TOPIC = "bitcoin-price";
    private static final String KAFKA_BROKER = "localhost:9092";

    // Using UnsafeOkHttpClient to bypass SSL verification
    private static final OkHttpClient client = UnsafeOkHttpClient.getUnsafeOkHttpClient();

    public static void main(String[] args) {
        // Kafka producer configuration
        Properties props = new Properties();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, KAFKA_BROKER);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        KafkaProducer<String, String> producer = new KafkaProducer<>(props);

        // Create the WebSocket request to CoinAPI
        Request request = new Request.Builder()
                .url("wss://ws.coinapi.io/v1/")
                .addHeader("X-CoinAPI-Key", API_KEY)
                .build();

        WebSocketListener listener = new WebSocketListener() {
            @Override
            public void onOpen(WebSocket webSocket, okhttp3.Response response) {
                System.out.println("Connected to CoinAPI WebSocket!");
                // Optionally send a subscription message after connection
                webSocket.send("{ \"type\": \"hello\", \"apikey\": \"" + API_KEY + "\", \"heartbeat\": false, \"subscribe_data_type\": [\"trade\"], \"subscribe_filter_symbol_id\": [\"BITSTAMP_SPOT_BTC_USD\"] }");
            }

            @Override
            public void onMessage(WebSocket webSocket, String text) {
                try {
                    // Parse the JSON response into BitcoinPrice object
                    BitcoinPrice bitcoinPrice = parseBitcoinPriceData(text);

                    // Send Bitcoin price data to Kafka topic
                    if (bitcoinPrice != null) {
                        producer.send(new ProducerRecord<>(KAFKA_TOPIC, "bitcoin-price", bitcoinPrice.toString()));
                        System.out.println("Sent to Kafka: " + bitcoinPrice.toString());
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onFailure(WebSocket webSocket, Throwable t, okhttp3.Response response) {
                t.printStackTrace();
            }
        };

        // Start WebSocket connection
        client.newWebSocket(request, listener);
        client.dispatcher().executorService().shutdown();
    }

    // Method to parse JSON data into BitcoinPrice object
    private static BitcoinPrice parseBitcoinPriceData(String jsonText) {
        try {
            JSONObject jsonObject = new JSONObject(jsonText);

            // Create and populate the BitcoinPrice object
            BitcoinPrice bitcoinPrice = new BitcoinPrice();
            bitcoinPrice.setAssetId(jsonObject.getString("asset_id_base"));
            bitcoinPrice.setPrice(jsonObject.getDouble("rate"));
            bitcoinPrice.setCurrency(jsonObject.getString("asset_id_quote"));
            bitcoinPrice.setTimestamp(jsonObject.getString("time"));
            bitcoinPrice.setVolume(jsonObject.optDouble("volume", 0.0)); // Default to 0.0 if not present
            bitcoinPrice.setMarketCap(jsonObject.optDouble("market_cap", 0.0)); // Default to 0.0 if not present
            bitcoinPrice.setHigh24h(jsonObject.optDouble("high_24h", 0.0)); // Default to 0.0 if not present
            bitcoinPrice.setLow24h(jsonObject.optDouble("low_24h", 0.0)); // Default to 0.0 if not present

            return bitcoinPrice;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}
